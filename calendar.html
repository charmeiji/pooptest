<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Doodle Calendar</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      font-family:
        "MS PGothic","MS Gothic",
        "Osaka",
        "Hiragino Kaku Gothic ProN",
        "Meiryo",
        sans-serif;
      font-size: 12px;
      line-height: 1.35;
      color: #111;
      background: #fff;
    }
    #container { display: flex; }
    #calendar-section { flex: 1; }
    #doodle-display { padding-left: 20px; }
    #nav { width: 200px; padding-left: 20px; }
    #nav img { height: 50px; }
    #doodle-display.hidden { display: none; }
    #left-meta { margin-top: 14px; font-size: 12px; }
    .meta-block { margin-top: 10px; }
    .meta-title { font-weight: bold; margin-bottom: 4px; }
    .meta-text, #recent-list { opacity: 0.85; }
    .recent-item { display:block; text-decoration:none; color: inherit; margin: 2px 0; }
    .recent-item:hover { text-decoration: underline; }
  </style>
</head>
<body>

<div id="container">
<div id="calendar-section">
<h1>Doodle Calendar</h1>

<script>
/* ---- Calendar template core (simplified from the template's approach) ---- */
const monthnames = [
  "January","February","March","April","May","June",
  "July","August","September","October","November","December"
];

const monthdays = [31,28,31,30,31,30,31,31,30,31,30,31];

function isLeapYear(y) {
  return (y % 4 === 0 && y % 100 !== 0) || (y % 400 === 0);
}

function showDoodle(date) {
  const display = document.getElementById("doodle-display");
  const img = document.getElementById("doodle-img");
  const title = document.getElementById("doodle-title");
  const journal = document.getElementById("doodle-journal");
  
  // Show the display area
  display.classList.remove("hidden");
  title.textContent = date;
  
  // Helper function to escape HTML and convert newlines to <br>
  function escapeHtmlAndConvertNewlines(text) {
    // Escape HTML entities first
    const div = document.createElement('div');
    div.textContent = text;
    const escaped = div.innerHTML;
    // Convert newlines to <br> tags (preserve line breaks)
    return escaped.replace(/\n/g, "<br>");
  }
  
  // Fetch journal entry with cache-busting
  const entryPath = `entries/${date}.txt`;
  const cacheBuster = '?v=' + Date.now();
  
  fetch(entryPath + cacheBuster, { cache: "no-store" })
    .then(response => {
      if (response.ok) {
        return response.text();
      } else {
        throw new Error('Not found');
      }
    })
    .then(text => {
      journal.innerHTML = escapeHtmlAndConvertNewlines(text);
      journal.style.display = "block";
    })
    .catch(() => {
      journal.textContent = "(no journal entry)";
      journal.style.display = "block";
    });
  
  // Try to load image: PNG first, then JPG
  const timestamp = Date.now();
  const pngPath = `art/${date}.png?v=${timestamp}`;
  const jpgPath = `art/${date}.jpg?v=${timestamp}`;
  
  // Reset image display
  img.style.display = "block";
  
  // Try PNG first
  const testImg = new Image();
  testImg.onload = function() {
    img.src = pngPath;
    img.style.display = "block";
  };
  testImg.onerror = function() {
    // PNG failed, try JPG
    const testJpg = new Image();
    testJpg.onload = function() {
      img.src = jpgPath;
      img.style.display = "block";
    };
    testJpg.onerror = function() {
      // Both failed, hide image
      img.style.display = "none";
    };
    testJpg.src = jpgPath;
  };
  testImg.src = pngPath;
}

function renderCalendar(year, monthIndex) {
  // monthIndex: 0-11
  const first = new Date(year, monthIndex, 1);
  const startDay = first.getDay(); // 0=Sun
  let daysInMonth = monthdays[monthIndex];
  if (monthIndex === 1 && isLeapYear(year)) daysInMonth = 29;

  document.write(`<h2>${monthnames[monthIndex]} ${year}</h2>`);
  document.write(`<table border="2" cellpadding="8" cellspacing="0">`);
  document.write(`<tr>
    <th>Su</th><th>M</th><th>Tu</th><th>W</th><th>Th</th><th>F</th><th>Sa</th>
  </tr>`);

  let day = 1;
  for (let row = 0; row < 6; row++) {
    document.write("<tr>");
    for (let col = 0; col < 7; col++) {
      const cellIndex = row * 7 + col;

      if (cellIndex < startDay || day > daysInMonth) {
        document.write("<td>&nbsp;</td>");
      } else {
        const mm = String(monthIndex + 1).padStart(2, "0");
        const dd = String(day).padStart(2, "0");
        const iso = `${year}-${mm}-${dd}`;

        // All days are clickable
        document.write(`<td><a href="#" onclick="showDoodle('${iso}'); return false;">${day}</a></td>`);
        day++;
      }
    }
    document.write("</tr>");
    if (day > daysInMonth) break;
  }

  document.write("</table>");
}

/* ---- 3) Render current month ---- */
const now = new Date();
renderCalendar(now.getFullYear(), now.getMonth());
</script>

<div id="left-meta">
  <div class="meta-block" id="recent-block">
    <div class="meta-title">Recent</div>
    <div id="recent-list">(loading…)</div>
  </div>

  <div class="meta-block" id="legend-block">
    <div class="meta-title">Legend</div>
    <div class="meta-text">■ day with entry</div>
    <div class="meta-text">□ empty day</div>
  </div>

  <div class="meta-block" id="status-block">
    <div class="meta-title">Status</div>
    <div class="meta-text" id="status-updated">last update: (loading…)</div>
    <div class="meta-text" id="status-monthcount">entries this month: (loading…)</div>
  </div>
</div>

<script>
// Load entries.json and populate Recent + Status
(async function() {
  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = now.getMonth();
  const currentMonthStr = String(currentMonth + 1).padStart(2, "0");
  const currentMonthYear = `${currentYear}-${currentMonthStr}`;
  
  let entries = [];
  
  try {
    const response = await fetch('entries.json', { cache: "no-store" });
    if (response.ok) {
      entries = await response.json();
    } else {
      throw new Error('Not found');
    }
  } catch (error) {
    document.getElementById("recent-list").textContent = "(no entries.json found)";
    document.getElementById("status-updated").textContent = "last update: (no entries.json found)";
    document.getElementById("status-monthcount").textContent = "entries this month: (no entries.json found)";
    return;
  }
  
  // Populate Status: last update
  if (entries.length > 0) {
    document.getElementById("status-updated").textContent = `last update: ${entries[0]}`;
  } else {
    document.getElementById("status-updated").textContent = "last update: (no entries)";
  }
  
  // Populate Status: entries this month
  const monthEntries = entries.filter(date => {
    return date.startsWith(currentMonthYear);
  });
  document.getElementById("status-monthcount").textContent = `entries this month: ${monthEntries.length}`;
  
  // Populate Recent: last 5 entries
  const recentEntries = entries.slice(0, 5);
  const recentList = document.getElementById("recent-list");
  recentList.innerHTML = "";
  
  if (recentEntries.length === 0) {
    recentList.textContent = "(no entries)";
  } else {
    // Fetch each entry's first line
    const promises = recentEntries.map(async (date) => {
      try {
        const response = await fetch(`entries/${date}.txt`, { cache: "no-store" });
        if (response.ok) {
          const text = await response.text();
          const lines = text.split('\n');
          let firstLine = "";
          for (let i = 0; i < lines.length; i++) {
            const trimmed = lines[i].trim();
            if (trimmed) {
              firstLine = trimmed;
              break;
            }
          }
          
          if (!firstLine) {
            firstLine = "(no text)";
          } else if (firstLine.length > 40) {
            firstLine = firstLine.substring(0, 40) + "…";
          }
          
          return { date, microNote: firstLine };
        } else {
          return { date, microNote: "(no text)" };
        }
      } catch (error) {
        return { date, microNote: "(no text)" };
      }
    });
    
    const results = await Promise.all(promises);
    
    results.forEach(({ date, microNote }) => {
      const link = document.createElement("a");
      link.className = "recent-item";
      link.href = "#";
      link.setAttribute("data-date", date);
      link.textContent = `${date}  ${microNote}`;
      link.addEventListener("click", function(e) {
        e.preventDefault();
        showDoodle(date);
      });
      recentList.appendChild(link);
    });
  }
})();
</script>
</div>

<div id="doodle-display" class="hidden">
  <table align="center" cellpadding="12" cellspacing="0">
    <!-- TOP BORDER (wider) -->
    <tr>
      <td colspan="5" align="center">
        ⊹˚₊‧────────────────────────────────────────────────────────────────────‧₊˚⊹
      </td>
    </tr>

    <tr>
      <!-- LEFT OUTER BORDER (ornamental) -->
      <td valign="top" align="center">
        ⊹<br>
        ✧<br>
        ˚<br>
        ₊<br>
        ‧<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        ‧<br>
        ₊<br>
        ˚<br>
        ✧<br>
        ⊹
      </td>

      <!-- TEXT SIDE -->
      <td valign="top" width="396" style="font-size: 2em;">
        <font face="MS PGothic,MS Gothic,Osaka,Meiryo,Hiragino Kaku Gothic ProN,Arial,sans-serif"><small>
          <b id="doodle-title">2026-01-25</b><br><br>
          <div id="doodle-journal">
            Today's journal entry goes here.<br>
            This side is for writing.<br>
            It should feel quiet and personal.<br><br>

            Short lines work best.<br>
            Like a postcard message.
          </div>
        </small></font>
      </td>

      <!-- CENTER DIVIDER -->
      <td valign="top" align="center">
        │<br>
        ·<br>
        │<br>
        ·<br>
        │<br>
        ·<br>
        │<br>
        ·<br>
        │<br>
        ·<br>
        │<br>
        ·<br>
        │<br>
        ·<br>
        │<br>
        ·<br>
        │<br>
        ·<br>
        │<br>
        ·<br>
        │
      </td>

      <!-- ART SIDE -->
      <td valign="top" width="440" align="center">
        <img
          id="doodle-img"
          src=""
          width="400"
          alt="Daily doodle"
          style="display: none;"
        >
      </td>

      <!-- RIGHT OUTER BORDER (mirrors left) -->
      <td valign="top" align="center">
        ⊹<br>
        ✧<br>
        ˚<br>
        ₊<br>
        ‧<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        │<br>
        ‧<br>
        ₊<br>
        ˚<br>
        ✧<br>
        ⊹
      </td>
    </tr>

    <!-- BOTTOM BORDER (wider) -->
    <tr>
      <td colspan="5" align="center">
        ⊹˚₊‧────────────────────────────────────────────────────────────────────‧₊˚⊹
      </td>
    </tr>
  </table>
</div>

<div id="nav">
  <a href="index.html"><img src="img/home2.png" alt="Home"></a><br>
  <a href="calendar.html"><img src="img/calendar.png" alt="Calendar"></a><br>
  <a href="media.html"><img src="img/media.png" alt="Media"></a><br>
  <a href="archive.html"><img src="img/archive.png" alt="Archive"></a><br>
  <a href="other.html"><img src="img/other.png" alt="Other"></a><br>
  <a href="contact.html"><img src="img/contact.png" alt="Contact"></a><br>

</div>
</div>

</body>
</html>